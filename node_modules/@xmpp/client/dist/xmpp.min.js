!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XMPP=t()}}(function(){function t(e){var r;return function(t){return r||e(r={exports:{},parent:t},r.exports),r.exports}}var e=t(function(t,e){"use strict";var r;r=function(t,e){function r(){}r.prototype.name="PLAIN",r.prototype.clientFirst=!0,r.prototype.response=function(t){var e="";return e+=t.authzid||"",e+="\0",e+=t.username,e+="\0",e+=t.password},r.prototype.challenge=function(t){return this},e.exports=r},"object"==typeof e&&r(0,t)}),r=t(function(t,e){"use strict";var r;r=function(t,e){function r(){}r.prototype.name="ANONYMOUS",r.prototype.clientFirst=!0,r.prototype.response=function(t){return t.trace||""},r.prototype.challenge=function(t){},e.exports=r},"object"==typeof e&&r(0,t)}),n=t(function(t,e){"use strict";var r;r=function(t,e){function r(){this._mechs=[]}r.prototype.use=function(t,e){return e||(t=(e=t).prototype.name),this._mechs.push({name:t,mech:e}),this},r.prototype.create=function(t){for(var e=0,r=this._mechs.length;e<r;e++)for(var n=0,o=t.length;n<o;n++){var i=this._mechs[e];if(i.name==t[n])return new i.mech}return null},e.exports=r},"object"==typeof e&&r(0,t)});var s=function(t){return t&&t.__esModule?t:{default:t}};function o(t,e){if(null==t)return{};var r,n,o={},i=Object.keys(t);for(n=0;n<i.length;n++)r=i[n],0<=e.indexOf(r)||(o[r]=t[r]);return o}function a(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}var i={};function u(t){return i=u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},u(t)}i=u;var c={};function f(t,e){return c=f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},f(t,e)}c=f;var l=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")},h={};function p(t,e,r){return h=p=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var o=new(Function.bind.apply(t,n));return r&&c(o,r.prototype),o},p.apply(null,arguments)}h=p;var m={};function d(t){var r="function"==typeof Map?new Map:void 0;return m=d=function(t){if(null===t||!l(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(t))return r.get(t);r.set(t,e)}function e(){return h(t,arguments,i(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),c(e,t)},d(t)}m=d;function v(e){var r,t=new Promise(function(t){r=setTimeout(t,e)});return t.timeout=r,t}var y=s(a),g=function(r){function t(t){var e;return(e=r.call(this,t)||this).name="TimeoutError",e}return(0,y.default)(t,r),t}((0,s(m).default)(Error)),w=Object.create||function(t){function e(){}return e.prototype=t,new e},b=Object.keys||function(t){var e=[];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.push(r);return r},x=Function.prototype.bind||function(t){var e=this;return function(){return e.apply(t,arguments)}};function _(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=w(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}var P=_;(_.EventEmitter=_).prototype._events=void 0,_.prototype._maxListeners=void 0;var E,j=10;try{var L={};Object.defineProperty&&Object.defineProperty(L,"x",{value:0}),E=0===L.x}catch(t){E=!1}function O(t){return void 0===t._maxListeners?_.defaultMaxListeners:t._maxListeners}function S(t,e,r,n){var o,i,s;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((i=t._events)?(i.newListener&&(t.emit("newListener",e,r.listener?r.listener:r),i=t._events),s=i[e]):(i=t._events=w(null),t._eventsCount=0),s){if("function"==typeof s?s=i[e]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),!s.warned&&(o=O(t))&&0<o&&s.length>o){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+' "'+String(e)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');a.name="MaxListenersExceededWarning",a.emitter=t,a.type=e,a.count=s.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",a.name,a.message)}}else s=i[e]=r,++t._eventsCount;return t}function k(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var t=new Array(arguments.length),e=0;e<t.length;++e)t[e]=arguments[e];this.listener.apply(this.target,t)}}function C(t,e,r){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:r},o=x.call(k,n);return o.listener=r,n.wrapFn=o}function T(t,e,r){var n=t._events;if(!n)return[];var o=n[e];return o?"function"==typeof o?r?[o.listener||o]:[o]:r?function(t){for(var e=new Array(t.length),r=0;r<e.length;++r)e[r]=t[r].listener||t[r];return e}(o):M(o,o.length):[]}function A(t){var e=this._events;if(e){var r=e[t];if("function"==typeof r)return 1;if(r)return r.length}return 0}function M(t,e){for(var r=new Array(e),n=0;n<e;++n)r[n]=t[n];return r}E?Object.defineProperty(_,"defaultMaxListeners",{enumerable:!0,get:function(){return j},set:function(t){if("number"!=typeof t||t<0||t!=t)throw new TypeError('"defaultMaxListeners" must be a positive number');j=t}}):_.defaultMaxListeners=j,_.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},_.prototype.getMaxListeners=function(){return O(this)},_.prototype.emit=function(t,e,r,n){var o,i,s,a,u,c,f="error"===t;if(c=this._events)f=f&&null==c.error;else if(!f)return!1;if(f){if(1<arguments.length&&(o=e),o instanceof Error)throw o;var l=new Error('Unhandled "error" event. ('+o+")");throw l.context=o,l}if(!(i=c[t]))return!1;var h="function"==typeof i;switch(s=arguments.length){case 1:!function(t,e,r){if(e)t.call(r);else for(var n=t.length,o=M(t,n),i=0;i<n;++i)o[i].call(r)}(i,h,this);break;case 2:!function(t,e,r,n){if(e)t.call(r,n);else for(var o=t.length,i=M(t,o),s=0;s<o;++s)i[s].call(r,n)}(i,h,this,e);break;case 3:!function(t,e,r,n,o){if(e)t.call(r,n,o);else for(var i=t.length,s=M(t,i),a=0;a<i;++a)s[a].call(r,n,o)}(i,h,this,e,r);break;case 4:!function(t,e,r,n,o,i){if(e)t.call(r,n,o,i);else for(var s=t.length,a=M(t,s),u=0;u<s;++u)a[u].call(r,n,o,i)}(i,h,this,e,r,n);break;default:for(a=new Array(s-1),u=1;u<s;u++)a[u-1]=arguments[u];!function(t,e,r,n){if(e)t.apply(r,n);else for(var o=t.length,i=M(t,o),s=0;s<o;++s)i[s].apply(r,n)}(i,h,this,a)}return!0},_.prototype.on=_.prototype.addListener=function(t,e){return S(this,t,e,!1)},_.prototype.prependListener=function(t,e){return S(this,t,e,!0)},_.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,C(this,t,e)),this},_.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,C(this,t,e)),this},_.prototype.removeListener=function(t,e){var r,n,o,i,s;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(r=n[t]))return this;if(r===e||r.listener===e)0==--this._eventsCount?this._events=w(null):(delete n[t],n.removeListener&&this.emit("removeListener",t,r.listener||e));else if("function"!=typeof r){for(o=-1,i=r.length-1;0<=i;i--)if(r[i]===e||r[i].listener===e){s=r[i].listener,o=i;break}if(o<0)return this;0===o?r.shift():function(t,e){for(var r=e,n=r+1,o=t.length;n<o;r+=1,n+=1)t[r]=t[n];t.pop()}(r,o),1===r.length&&(n[t]=r[0]),n.removeListener&&this.emit("removeListener",t,s||e)}return this},_.prototype.removeAllListeners=function(t){var e,r,n;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=w(null),this._eventsCount=0):r[t]&&(0==--this._eventsCount?this._events=w(null):delete r[t]),this;if(0===arguments.length){var o,i=b(r);for(n=0;n<i.length;++n)"removeListener"!==(o=i[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=w(null),this._eventsCount=0,this}if("function"==typeof(e=r[t]))this.removeListener(t,e);else if(e)for(n=e.length-1;0<=n;n--)this.removeListener(t,e[n]);return this},_.prototype.listeners=function(t){return T(this,t,!0)},_.prototype.rawListeners=function(t){return T(this,t,!1)},_.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):A.call(t,e)},_.prototype.listenerCount=A,_.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var N={};N.EventEmitter=P,N.timeout=function(t,e){var r=v(e);return Promise.race([t.finally(function(){clearTimeout(r.timeout)}),r.then(function(){throw new g})])},N.promise=function(s,a,u,c){return void 0===u&&(u="error"),new Promise(function(e,r){var t,n=function(){clearTimeout(t),s.removeListener(a,i),s.removeListener(u,o)};function o(t){r(t),n()}function i(t){e(t),n()}s.once(a,i),u&&s.once(u,o),c&&(t=setTimeout(function(){n(),r(new g)},c))})},N.Deferred=function(){var r=this;this.promise=new Promise(function(t,e){r.resolve=t,r.reject=e})};var q={detect:function(t){return!!t&&-1!==t.replace(/\\20/g,"").replace(/\\22/g,"").replace(/\\26/g,"").replace(/\\27/g,"").replace(/\\2f/g,"").replace(/\\3a/g,"").replace(/\\3c/g,"").replace(/\\3e/g,"").replace(/\\40/g,"").replace(/\\5c/g,"").search(/\\| |"|&|'|\/|:|<|>|@/g)},escape:function(t){return null===t?null:t.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40").replace(/\3a/g,"c3a")},unescape:function(t){return null===t?null:t.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")}},X=function(){function t(t,e,r){if("string"!=typeof e||!e)throw new TypeError("Invalid domain.");this.setDomain(e),this.setLocal("string"==typeof t?t:""),this.setResource("string"==typeof r?r:"")}var e=t.prototype;return e[Symbol.toPrimitive]=function(t){return"number"===t?NaN:this.toString()},e.toString=function(t){var e=this._domain;return this._local&&(e=this.getLocal(t)+"@"+e),this._resource&&(e=e+"/"+this._resource),e},e.bare=function(){return this._resource?new t(this._local,this._domain,null):this},e.equals=function(t){return this._local===t._local&&this._domain===t._domain&&this._resource===t._resource},e.setLocal=function(t,e){return(e=e||q.detect(t))&&(t=q.escape(t)),this._local=t&&t.toLowerCase(),this},e.getLocal=function(t){return(t=t||!1)?q.unescape(this._local):this._local},e.setDomain=function(t){return this._domain=t.toLowerCase(),this},e.getDomain=function(){return this._domain},e.setResource=function(t){return this._resource=t,this},e.getResource=function(){return this._resource},t}();Object.defineProperty(X.prototype,"local",{get:X.prototype.getLocal,set:X.prototype.setLocal}),Object.defineProperty(X.prototype,"domain",{get:X.prototype.getDomain,set:X.prototype.setDomain}),Object.defineProperty(X.prototype,"resource",{get:X.prototype.getResource,set:X.prototype.setResource});var F=X,R=function(t){var e,r,n=t.indexOf("/");-1!==n&&(r=t.slice(n+1),t=t.slice(0,n));var o=t.indexOf("@");return-1!==o&&(e=t.slice(0,o),t=t.slice(o+1)),new F(e,t,r)},z={},D=s(h);function B(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return e[1]||e[2]?(0,D.default)(F,e):R.apply(void 0,e)}(z=z=B.bind()).jid=B,z.JID=F,z.equal=function(t,e){return t.equals(e)},z.detectEscape=q.detect,z.escapeLocal=q.escape,z.unescapeLocal=q.unescape,z.parse=R;var I={},U={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function W(t){return U[t]}var H={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function J(t){if("#"===t[1]){var e;if(9===(e="x"===t[2]?parseInt(t.slice(3),16):parseInt(t.slice(2),10))||10===e||13===e||32<=e&&e<=55295||57344<=e&&e<=65533||65536<=e&&e<=1114111)return String.fromCodePoint(e);throw new Error("Illegal XML character 0x"+e.toString(16))}if(H[t])return H[t]||t;throw new Error("Illegal XML entity "+t)}I.escapeXML=function(t){return t.replace(/&|<|>|"|'/g,W)},I.unescapeXML=function(t){for(var e="",r=-1,n=-1,o=0;-1!==(r=t.indexOf("&",o))&&-1!==(n=t.indexOf(";",r+1));)e=e+t.substring(o,r)+J(t.substring(r,n+1)),o=n+1;return 0===o?t:e+=t.substring(o)},I.escapeXMLText=function(t){return t.replace(/&|<|>/g,W)},I.unescapeXMLText=function(t){return t.replace(/&(amp|#38|lt|#60|gt|#62);/g,J)};var Y={};function K(t,e){return t.name===e.name}function $(t,e){var r=t.attrs,n=Object.keys(r),o=n.length;if(o!==Object.keys(e.attrs).length)return!1;for(var i=0,s=o;i<s;i++){var a=n[i],u=r[a];if(null==u||null==e.attrs[a]){if(u!==e.attrs[a])return!1}else if(u.toString()!==e.attrs[a].toString())return!1}return!0}function G(t,e){var r=t.children,n=r.length;if(n!==e.children.length)return!1;for(var o=0,i=n;o<i;o++){var s=r[o];if("string"==typeof s){if(s!==e.children[o])return!1}else if(!s.equals(e.children[o]))return!1}return!0}Y.name=K,Y.attrs=$,Y.children=G,Y.equal=function(t,e){return!!K(t,e)&&(!!$(t,e)&&!!G(t,e))};var Q=I.escapeXML,V=I.escapeXMLText,Z=Y.equal,tt=Y.name,et=Y.attrs,rt=Y.children;function nt(t,e){this.name=t,this.parent=null,this.children=[],this.attrs={},this.setAttrs(e)}nt.prototype.is=function(t,e){return this.getName()===t&&(!e||this.getNS()===e)},nt.prototype.getName=function(){return 0<=this.name.indexOf(":")?this.name.substr(this.name.indexOf(":")+1):this.name},nt.prototype.getNS=function(){if(0<=this.name.indexOf(":")){var t=this.name.substr(0,this.name.indexOf(":"));return this.findNS(t)}return this.findNS()},nt.prototype.findNS=function(t){if(t){var e="xmlns:"+t;if(this.attrs[e])return this.attrs[e];if(this.parent)return this.parent.findNS(t)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}},nt.prototype.getXmlns=function(){var t={};for(var e in this.parent&&(t=this.parent.getXmlns()),this.attrs){var r=e.match("xmlns:?(.*)");this.attrs.hasOwnProperty(e)&&r&&(t[this.attrs[e]]=r[1])}return t},nt.prototype.setAttrs=function(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.keys(e).forEach(function(t){this.attrs[t]=e[t]},this)},nt.prototype.getAttr=function(t,e){if(!e)return this.attrs[t];var r=this.getXmlns();return r[e]?this.attrs[[r[e],t].join(":")]:null},nt.prototype.getChild=function(t,e){return this.getChildren(t,e)[0]},nt.prototype.getChildren=function(t,e){for(var r=[],n=0;n<this.children.length;n++){var o=this.children[n];!o.getName||o.getName()!==t||e&&o.getNS()!==e||r.push(o)}return r},nt.prototype.getChildByAttr=function(t,e,r,n){return this.getChildrenByAttr(t,e,r,n)[0]},nt.prototype.getChildrenByAttr=function(t,e,r,n){for(var o=[],i=0;i<this.children.length;i++){var s=this.children[i];!s.attrs||s.attrs[t]!==e||r&&s.getNS()!==r||o.push(s),n&&s.getChildrenByAttr&&o.push(s.getChildrenByAttr(t,e,r,!0))}return n&&(o=[].concat.apply([],o)),o},nt.prototype.getChildrenByFilter=function(t,e){for(var r=[],n=0;n<this.children.length;n++){var o=this.children[n];t(o)&&r.push(o),e&&o.getChildrenByFilter&&r.push(o.getChildrenByFilter(t,!0))}return e&&(r=[].concat.apply([],r)),r},nt.prototype.getText=function(){for(var t="",e=0;e<this.children.length;e++){var r=this.children[e];"string"!=typeof r&&"number"!=typeof r||(t+=r)}return t},nt.prototype.getChildText=function(t,e){var r=this.getChild(t,e);return r?r.getText():null},nt.prototype.getChildElements=function(){return this.getChildrenByFilter(function(t){return t instanceof nt})},nt.prototype.tree=nt.prototype.root=function(){return this.parent?this.parent.root():this},nt.prototype.up=function(){return this.parent?this.parent:this},nt.prototype.c=function(t,e){return this.cnode(new nt(t,e))},nt.prototype.cnode=function(t){return this.children.push(t),"object"==typeof t&&(t.parent=this),t},nt.prototype.t=function(t){return this.children.push(t),this},nt.prototype.remove=function(e,r){var t;return t="string"==typeof e?function(t){return!(t.is&&t.is(e,r))}:function(t){return t!==e},this.children=this.children.filter(t),this},nt.prototype.clone=function(){return function(t){for(var e=new t.constructor(t.name,t.attrs),r=0;r<t.children.length;r++){var n=t.children[r];e.cnode(n.clone?n.clone():n)}return e}(this)},nt.prototype.text=function(t){return t&&1===this.children.length?(this.children[0]=t,this):this.getText()},nt.prototype.attr=function(t,e){return void 0!==e||null===e?(this.attrs||(this.attrs={}),this.attrs[t]=e,this):this.attrs[t]},nt.prototype.toString=function(){var e="";return this.write(function(t){e+=t}),e},nt.prototype.toJSON=function(){return{name:this.name,attrs:this.attrs,children:this.children.map(function(t){return t&&t.toJSON?t.toJSON():t})}},nt.prototype._addChildren=function(t){t(">");for(var e=0;e<this.children.length;e++){var r=this.children[e];!r&&0!==r||(r.write?r.write(t):"string"==typeof r?t(V(r)):r.toString&&t(V(r.toString(10))))}t("</"),t(this.name),t(">")},nt.prototype.write=function(t){for(var e in t("<"),t(this.name),this.attrs){var r=this.attrs[e];null!=r&&(t(" "),t(e),t('="'),"string"!=typeof r&&(r=r.toString()),t(Q(r)),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)},nt.prototype.nameEquals=function(t){return tt(this,t)},nt.prototype.attrsEquals=function(t){return et(this,t)},nt.prototype.childrenEquals=function(t){return rt(this,t)},nt.prototype.equals=function(t){return Z(this,t)};var ot=nt,it=s(a),st=function(t){function e(){return t.apply(this,arguments)||this}(0,it.default)(e,t);var r=e.prototype;return r.setAttrs=function(r){"string"==typeof r?this.attrs.xmlns=r:r&&Object.keys(r).forEach(function(t){var e=r[t];null!=e&&(this.attrs[t.toString()]=e.toString())},this)},r.append=function(t){var e=this;return(t=Array.isArray(t)?t:[t]).forEach(function(t){e.children.push(t),"object"==typeof t&&(t.parent=e)}),this},r.prepend=function(t){var e=this;return(t=Array.isArray(t)?t:[t]).forEach(function(t){e.children.unshift(t),"object"==typeof t&&(t.parent=e)}),this},e}(ot);function at(e,t){t instanceof st?e.append(t):Array.isArray(t)?t.forEach(function(t){return at(e,t)}):null!=t&&e.append(String(t))}var ut=function(t,e){for(var r=new st(t,e),n=0;n<(arguments.length<=2?0:arguments.length-2);n++)at(r,n+2<2||arguments.length<=n+2?void 0:arguments[n+2]);return r};function ct(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var ft={};ft="function"==typeof Object.create?function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:function(t,e){t.super_=e;function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t};var lt,ht=P.EventEmitter,pt=I.unescapeXML,mt=lt=function(){ht.call(this);var h,p,m,d,v,y,g,w,b=0,x=0;this._handleTagOpening=function(t,e,r){t?this.emit("endElement",e):(this.emit("startElement",e,r),v&&this.emit("endElement",e))},this.write=function(e){"string"!=typeof e&&(e=e.toString());var r=0;function t(){if("number"==typeof x){var t=e.substring(x,r);return x=void 0,t}}for(h&&(e=h+e,r+=h.length,h=null);r<e.length;r++){if(0===b){var n=e.indexOf("<",r);-1!==n&&r!==n&&(r=n)}else if(8===b){var o=e.indexOf(g,r);-1!==o&&(r=o)}else if(1===b){var i=e.indexOf("--\x3e",r);-1!==i&&(r=i+2)}var s=e.charCodeAt(r);switch(b){case 0:if(60===s){var a=t();a&&this.emit("text",pt(a)),b=3,x=r+1,m={}}break;case 9:if(93===s&&"]>"===e.substr(r+1,2)){var u=t();u&&this.emit("text",u),b=1}break;case 3:47===s&&x===r?(x=r+1,d=!0):33===s?b="[CDATA["===e.substr(r+1,7)?(x=r+8,9):(x=void 0,1):63===s?(x=void 0,b=2):(s<=32||47===s||62===s)&&(p=t(),r--,b=4);break;case 1:if(62===s){var c=e.charCodeAt(r-1),f=e.charCodeAt(r-2);(45===c&&45===f||93===c&&93===f)&&(b=0)}break;case 2:if(62===s)63===e.charCodeAt(r-1)&&(b=0);break;case 4:62===s?(this._handleTagOpening(d,p,m),v=d=m=p=void 0,b=0,x=r+1):47===s?v=!0:32<s&&(x=r,b=5);break;case 5:(s<=32||61===s)&&(w=t(),r--,b=6);break;case 6:61===s&&(b=7);break;case 7:34!==s&&39!==s||(g=34===(y=s)?'"':"'",b=8,x=r+1);break;case 8:if(s===y){var l=pt(t());m[w]=l,w=void 0,b=4}}}"number"==typeof x&&x<=e.length&&(h=e.slice(x),x=0)}};ft(mt,ht),mt.prototype.end=function(t){t&&this.write(t),this.write=function(){}};var dt=s(ct),vt=s(a),yt=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="XMLError",t}return(0,vt.default)(t,o),t}((0,s(m).default)(Error)),gt=function(r){function t(){var t;t=r.call(this)||this;var e=new lt;return t.root=null,t.cursor=null,e.on("startElement",t.onStartElement.bind((0,dt.default)(t))),e.on("endElement",t.onEndElement.bind((0,dt.default)(t))),e.on("text",t.onText.bind((0,dt.default)(t))),t.parser=e,t}(0,vt.default)(t,r);var e=t.prototype;return e.onStartElement=function(t,e){var r=new st(t,e),n=this.root,o=this.cursor;n?o!==n&&o.append(r):(this.root=r,this.emit("start",r)),this.cursor=r},e.onEndElement=function(t){var e=this.root,r=this.cursor;if(t===r.name){if(r!==e)return r.parent?void(this.cursor=r.parent):(r.name.startsWith("stream:")&&(r.attrs["xmlns:stream"]=e.attrs["xmlns:stream"]),this.emit("element",r),void(this.cursor=e));this.emit("end",e)}else this.emit("error",new yt(r.name+" must be closed."))},e.onText=function(t){var e=this.cursor;e?e.t(t):this.emit("error",new yt(t+" must be a child."))},e.write=function(t){this.parser.write(t)},e.end=function(t){t&&this.parser.write(t)},t}(P);gt.XMLError=yt;var wt=gt,bt={},xt=I.escapeXML,_t=I.unescapeXML,Pt=I.escapeXMLText,Et=I.unescapeXMLText;bt=bt=function(){return ut.apply(void 0,arguments)},Object.assign(bt,{x:ut,Element:st,Parser:wt,escapeXML:xt,unescapeXML:_t,escapeXMLText:Pt,unescapeXMLText:Et});var jt=s(a),Lt=function(o){function t(t,e,r){var n;return(n=o.call(this,t+(e?" - "+e:""))||this).name="XMPPError",n.condition=t,n.text=e,n.application=r,n}return(0,jt.default)(t,o),t.fromElement=function(t){var e,r,n=t.children,o=n[0],i=n[1],s=n[2];i&&(i.is("text")?e=i:i&&(r=i),s&&(r=s));var a=new this(o.name,e?e.text():"",r);return a.element=t,a},t}((0,s(m).default)(Error)),Ot=s(a),St=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="StreamError",t}return(0,Ot.default)(t,o),t}(Lt),kt={};function Ct(t){var e=new URL(t),r=e.port,n=e.hostname;return"[::1]"===n&&(n="::1"),{port:r,hostname:n,protocol:e.protocol}}function Tt(t){var e=Ct("http://"+t);return{port:e.port,hostname:e.hostname}}Object.assign(kt,{parseURI:Ct,parseHost:Tt,parseService:function(t){return t.includes("://")?Ct(t):Tt(t)}});var At={},Mt=s(a);function Nt(){}var qt=N.EventEmitter,Xt=N.promise;function Ft(t,e){if(!e)return t&&t.then?t.then(Nt):Promise.resolve()}function Rt(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}function zt(t,e){return t&&t.then?t.then(e):e(t)}function Dt(t){if(t&&t.then)return t.then(Nt)}var Bt=kt.parseHost,It=kt.parseService;function Ut(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}function Wt(i){for(var t=arguments.length,s=new Array(1<t?t-1:0),e=1;e<t;e++)s[e-1]=arguments[e];return new Promise(function(e,r){function n(t){i.removeListener("connect",o),r(t)}function o(t){i.removeListener("error",n),e(t)}i.once("error",n),i.once("connect",o),i.connect.apply(i,s)})}var Ht=function(r){function t(t){var e;return void 0===t&&(t={}),(e=r.call(this)||this).jid=null,e.timeout=2e3,e.options=t,e.socketListeners=Object.create(null),e.parserListeners=Object.create(null),e.status="offline",e.socket=null,e.parser=null,e}(0,Mt.default)(t,r);var e=t.prototype;return e._reset=function(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()},e._streamError=function(t,e){try{var r=this;return zt(Rt(function(){return Ft(r.send(bt("stream:error",{},[bt(t,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},e)])))},Nt),function(){return r._end()})}catch(t){return Promise.reject(t)}},e._onData=function(t){try{var e=this,r=t.toString("utf8");return e.emit("input",r),Dt(Rt(function(){return Ft(e.parser.write(r))},function(){try{e._streamError("bad-format")}catch(t){}}))}catch(t){return Promise.reject(t)}},e._attachSocket=function(t){var r=this,e=this.socket=t,n=this.socketListeners;n.data=function(t){r._onData(t)},n.close=function(t,e){r._reset(),r._status("disconnect",{clean:!t,event:e})},n.connect=function(){r._status("connect")},n.error=function(t){r.emit("error",t)},e.on("close",n.close),e.on("data",n.data),e.on("error",n.error),e.on("connect",n.connect)},e._detachSocket=function(){var e=this.socketListeners,r=this.socket;return Object.getOwnPropertyNames(e).forEach(function(t){r.removeListener(t,e[t]),delete e[t]}),this.socket=null,r},e._onElement=function(t){this.emit("element",t),this.emit(this.isStanza(t)?"stanza":"nonza",t),"stream:error"===t.name&&this._onStreamError(t)},e._onStreamError=function(t){var e=St.fromElement(t);"see-other-host"===e.condition?this._onSeeOtherHost(e):this.emit("error",e),this._end()},e._onSeeOtherHost=function(t){try{var n,o=this,e=It(o.options.service).protocol,r=t.element.getChildText("see-other-host"),i=Bt(r).port;return n=i?(e||"xmpp:")+"//"+r:(e?e+"//":"")+r,Dt(Rt(function(){return Ut(Xt(o,"disconnect"),function(){var t=o.options,e=t.domain,r=t.lang;return Ut(o.connect(n),function(){return Ft(o.open({domain:e,lang:r}))})})},function(t){o.emit("error",t)}))}catch(t){return Promise.reject(t)}},e._attachParser=function(t){var e=this,r=this.parser=t,n=this.parserListeners;n.element=function(t){e._onElement(t)},n.error=function(t){e._detachParser(),e.emit("error",t)},n.end=function(t){e._detachParser(),e._status("close",t)},r.on("error",n.error),r.on("element",n.element),r.on("end",n.end)},e._detachParser=function(){var e=this,r=this.parserListeners;Object.getOwnPropertyNames(r).forEach(function(t){e.parser.removeListener(t,r[t]),delete r[t]}),this.parser=null},e._jid=function(t){return this.jid=z(t),this.jid},e._status=function(t){this.status=t;for(var e=arguments.length,r=new Array(1<e?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this.emit.apply(this,["status",t].concat(r)),this.emit.apply(this,[t].concat(r))},e._end=function(){try{var e,t=this;return zt(Rt(function(){return Ut(t.close(),function(t){e=t})},Nt),function(){return zt(Rt(function(){return Ft(t.disconnect())},Nt),function(){return e})})}catch(t){return Promise.reject(t)}},e.start=function(){try{var e=this;if("offline"!==e.status)throw new Error("Connection is not offline");var t=e.options,r=t.service,n=t.domain,o=t.lang;return Ut(e.connect(r),function(){var t=Xt(e,"online");return Ut(e.open({domain:n,lang:o}),function(){return t})})}catch(t){return Promise.reject(t)}},e.connect=function(t){try{var e=this;return e._status("connecting"),e._attachSocket(new e.Socket),Wt(e.socket,e.socketParameters(t))}catch(t){return Promise.reject(t)}},e.disconnect=function(t){try{var e=this;return void 0===t&&(t=e.timeout),e.socket&&e._status("disconnecting"),e.socket.end(),Ft(Xt(e.socket,"close","error",t))}catch(t){return Promise.reject(t)}},e.open=function(t){try{var e=this;e._status("opening"),"string"==typeof t&&(t={domain:t});var r=t,n=r.domain,o=r.lang,i=r.timeout,s=void 0===i?e.timeout:i,a=e.headerElement();return a.attrs.to=n,a.attrs["xml:lang"]=o,e._attachParser(new e.Parser),Ut(e.write(e.header(a)),function(){return Ut(Xt(e.parser,"start","error",s),function(t){e._status("open",t)})})}catch(t){return Promise.reject(t)}},e.stop=function(){try{var e=this;return Ut(e._end(),function(t){return"offline"!==e.status&&e._status("offline",t),t})}catch(t){return Promise.reject(t)}},e.close=function(t){try{var e=this;void 0===t&&(t=e.timeout);var r=Promise.all([Xt(e.parser,"end","error",t),e.write(e.footer(e.footerElement()))]);return e.parser&&e.socket&&e._status("closing"),Ut(r,function(t){return t[0]})}catch(t){return Promise.reject(t)}},e.restart=function(){try{this._detachParser();var t=this.options,e=t.domain,r=t.lang;return this.open({domain:e,lang:r})}catch(t){return Promise.reject(t)}},e.send=function(t){try{var e=this;return e.emit("outgoing",t),Ut(e.write(t),function(){e.emit("send",t)})}catch(t){return Promise.reject(t)}},e.sendReceive=function(t,e){return void 0===e&&(e=this.timeout),Promise.all([this.send(t),Xt(this,"element","error",e)]).then(function(t){return t[1]})},e.write=function(t){var o=this;return new Promise(function(e,r){if("closing"!==o.status){var n=t.toString("utf8");o.socket.write(n,function(t){if(t)return r(t);o.emit("output",n),e()})}else r(new Error("Connection is closing"))})},e.isStanza=function(t){var e=t.name;return"iq"===e||"message"===e||"presence"===e},e.isNonza=function(t){return!this.isStanza(t)},e.header=function(t){return t.toString()},e.headerElement=function(){return new bt.Element("",{version:"1.0",xmlns:this.NS})},e.footer=function(t){return t.toString()},e.footerElement=function(){},e.socketParameters=function(){},t}(qt);Ht.prototype.NS="",Ht.prototype.Socket=null,Ht.prototype.Parser=null,(At=Ht).socketConnect=Wt;var Jt=s(a),Yt=function(r){function t(t){var e;return(e=r.call(this,t)||this).transports=[],e}(0,Jt.default)(t,r);var e=t.prototype;return e.send=function(t){for(var e,r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return(e=this.Transport.prototype.send).call.apply(e,[this,t].concat(n))},e._findTransport=function(e){return this.transports.find(function(t){try{return void 0!==t.prototype.socketParameters(e)}catch(t){return!1}})},e.connect=function(t){var e=this._findTransport(t);if(!e)throw new Error("No compatible connection method found.");return this.Transport=e,this.Socket=e.prototype.Socket,this.Parser=e.prototype.Parser,r.prototype.connect.call(this,t)},e.socketParameters=function(){var t;return(t=this.Transport.prototype).socketParameters.apply(t,arguments)},e.header=function(){var t;return(t=this.Transport.prototype).header.apply(t,arguments)},e.headerElement=function(){var t;return(t=this.Transport.prototype).headerElement.apply(t,arguments)},e.footer=function(){var t;return(t=this.Transport.prototype).footer.apply(t,arguments)},e.footerElement=function(){var t;return(t=this.Transport.prototype).footerElement.apply(t,arguments)},t}(At);Yt.prototype.NS="jabber:client";var Kt=Yt,$t={};$t.Client=Kt,$t.xml=bt,$t.jid=z;var Gt=function(t){return(t.split("://")[1]||t).split(":")[0].split("/")[0]},Qt=s(a);function Vt(){}var Zt=function(r){function t(t){var e;return(e=r.call(this)||this).delay=1e3,e.entity=t,e._timeout=null,e}(0,Qt.default)(t,r);var e=t.prototype;return e.scheduleReconnect=function(){var t=this,e=this.entity,r=this.delay,n=this._timeout;clearTimeout(n),this._timeout=setTimeout(function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}(function(){if("disconnect"===e.status)return function(t){if(t&&t.then)return t.then(Vt)}(function(t,e){try{var r=t()}catch(t){return e(t)}if(r&&r.then)return r.then(void 0,e);return r}(function(){return function(t,e){if(!e)return t&&t.then?t.then(Vt):Promise.resolve()}(t.reconnect())},Vt))}),r)},e.reconnect=function(){try{var t=this,e=t.entity;t.emit("reconnecting");var r=e.options,n=r.service,o=r.domain,i=r.lang;return te(e.connect(n),function(){return te(e.open({domain:o,lang:i}),function(){t.emit("reconnected")})})}catch(t){return Promise.reject(t)}},e.start=function(){var t=this,e=this.entity,r={disconnect:function(){t.scheduleReconnect()}};this.listeners=r,e.on("disconnect",r.disconnect)},e.stop=function(){var t=this.entity,e=this.listeners,r=this._timeout;t.removeListener("disconnect",e.disconnect),clearTimeout(r)},t}(N.EventEmitter);function te(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var ee=function(t){var e=t.entity,r=new Zt(e);return r.start(),r},re={},ne={};(function(t){"use strict";var n=s(a),o=t.WebSocket||re,i="ECONNERROR";ne=function(e){function t(){var t;return(t=e.call(this)||this).listeners=Object.create(null),t}(0,n.default)(t,e);var r=t.prototype;return r.connect=function(t){this.url=t,this._attachSocket(new o(t,["xmpp"]))},r._attachSocket=function(t){var r=this,e=this.socket=t,n=this.listeners;n.open=function(){r.emit("connect")},n.message=function(t){var e=t.data;return r.emit("data",e)},n.error=function(t){var e=t.error;e||((e=new Error("WebSocket "+i+" "+r.url)).errno=i,e.code=i),e.event=t,e.url=r.url,r.emit("error",e)},n.close=function(t){r._detachSocket(),r.emit("close",!t.wasClean,t)},e.addEventListener("open",n.open),e.addEventListener("message",n.message),e.addEventListener("error",n.error),e.addEventListener("close",n.close)},r._detachSocket=function(){delete this.url;var e=this.socket,r=this.listeners;Object.getOwnPropertyNames(r).forEach(function(t){e.removeEventListener(t,r[t]),delete r[t]}),delete this.socket},r.end=function(){this.socket.close()},r.write=function(t,e){o===re?this.socket.send(t,e):(this.socket.send(t),e())},t}(P)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var oe=s(a),ie=bt.Parser,se=bt.Element,ae=bt.XMLError,ue=function(t){function e(){return t.apply(this,arguments)||this}(0,oe.default)(e,t);var r=e.prototype;return r.onStartElement=function(t,e){var r=new se(t,e),n=this.cursor;n&&n.append(r),this.cursor=r},r.onEndElement=function(t){var e=this.cursor;t===e.name?e.parent?this.cursor=e.parent:(e.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",e):e.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",e):this.emit("element",e),this.cursor=null):this.emit("error",new ae(e.name+" must be closed."))},e}(ie),ce=s(a),fe="urn:ietf:params:xml:ns:xmpp-framing",le=function(i){function t(){return i.apply(this,arguments)||this}(0,ce.default)(t,i);var e=t.prototype;return e.send=function(t){var e;!t.attrs.xmlns&&i.prototype.isStanza.call(this,t)&&(t.attrs.xmlns="jabber:client");for(var r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return(e=i.prototype.send).call.apply(e,[this,t].concat(n))},e.footerElement=function(){return new bt.Element("close",{xmlns:fe})},e.headerElement=function(){var t=i.prototype.headerElement.call(this);return t.name="open",t.attrs.xmlns=fe,t},e.socketParameters=function(t){return t.match(/^wss?:\/\//)?t:void 0},t}(At);le.prototype.Socket=ne,le.prototype.NS="jabber:client",le.prototype.Parser=ue;var he=le,pe=function(t){t.entity.transports.push(he)},me=function(s){if(!Array.isArray(s))throw new TypeError("Middleware stack must be an array!");var t=s,e=Array.isArray(t),r=0;for(t=e?t:t[Symbol.iterator]();;){var n;if(e){if(r>=t.length)break;n=t[r++]}else{if((r=t.next()).done)break;n=r.value}if("function"!=typeof n)throw new TypeError("Middleware must be composed of functions!")}return function(n,o){var i=-1;return function t(e){if(e<=i)return Promise.reject(new Error("next() called multiple times"));i=e;var r=s[e];e===s.length&&(r=o);if(!r)return Promise.resolve();try{return Promise.resolve(r(n,t.bind(null,e+1)))}catch(t){return Promise.reject(t)}}(0)}};function de(t,e){this.stanza=e,this.entity=t;var r=e.name,n=e.attrs,o=n.type,i=n.id;this.name=r,this.id=i||"",this.type="message"===r?o||"normal":"presence"===r?o||"available":o||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}var ve=s(a),ye=function(a){function t(t,e){var r;r=a.call(this,t,e)||this;var n=t.jid,o=t.domain,i=e.attrs.to||n&&n.toString(),s=e.attrs.from||o;return i&&(r.to=new z(i)),s&&(r.from=new z(s),r.local=r.from.local,r.domain=r.from.domain,r.resource=r.from.resource),r}return(0,ve.default)(t,a),t}(de),ge=s(a),we=function(a){function t(t,e){var r;r=a.call(this,t,e)||this;var n=t.jid,o=t.domain,i=e.attrs.from||n&&n.toString(),s=e.attrs.to||o;return i&&(r.from=new z(i)),s&&(r.to=new z(s),r.local=r.to.local,r.domain=r.to.domain,r.resource=r.to.resource),r}return(0,ge.default)(t,a),t}(de);function be(r,n,o){return function(t){var e=new o(r,t);return me(n)(e)}}var xe=function(t){var e=t.entity,r=[function(r){return function(t,e){e().then(function(t){return t&&r.send(t)}).catch(function(t){return r.emit("error",t)})}}(e)],n=[],o=be(e,r,ye),i=be(e,n,we);return e.on("element",o),e.hookOutgoing=i,{use:function(t){return r.push(t),t},filter:function(t){return n.push(t),t}}};function _e(){return function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}(function(t,e){var r=t.stanza,n=t.entity;return r.is("features","http://etherx.jabber.org/streams")?function(t,e,r){if(r)return e?e(t()):t();try{var n=Promise.resolve(t());return e?n.then(e):n}catch(t){return Promise.reject(t)}}(e,function(){n.jid&&n._status("online",n.jid)}):e()})}var Pe=function(t){var e=t.middleware;return e.use(_e()),{use:function(o,i,s){return e.use(function(t,e){var r=t.stanza;if(!r.is("features","http://etherx.jabber.org/streams"))return e();var n=r.getChild(o,i);return n?s(t,e,n):e()})}}},Ee=s(a),je=function(i){function t(t,e,r,n){var o;return(o=i.call(this,t,e,r)||this).type=n,o.name="StanzaError",o}return(0,Ee.default)(t,i),t.fromElement=function(t){var e=i.fromElement.call(this,t);return e.type=t.attrs.type,e},t}(Lt);function Le(){}var Oe=N.Deferred;var Se=N.timeout;var ke=function(t){var n=t.entity,e=t.middleware,a=new Map;return e.use(function(t,e){var r=t.type,n=t.name,o=t.id,i=t.stanza;if(!function(t){var e=t.name,r=t.type;return"iq"===e&&("error"===r||"result"===r)}({name:n,type:r}))return e();var s=a.get(o);if(!s)return e();"error"===r?s.reject(je.fromElement(i.getChild("error"))):s.resolve(i),a.delete(o)}),{handlers:a,request:function(e,t){void 0===t&&(t=3e4);try{e.attrs.id||(e.attrs.id=function(){for(var t;!t;)t=Math.random().toString(36).slice(2,12);return t}());var r=new Oe;return a.set(e.attrs.id,r),function(t,e){return t&&t.then?t.then(e):e(t)}(function(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}(function(){return function(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}(n.send(e),function(){return function(t,e){if(!e)return t&&t.then?t.then(Le):Promise.resolve()}(Se(r.promise,t))})},function(t){throw a.delete(e.attrs.id),t}),function(t){return r.promise})}catch(t){return Promise.reject(t)}}}};var Ce="urn:ietf:params:xml:ns:xmpp-stanzas";function Te(t){var e=t.stanza;return bt("iq",{to:e.attrs.from,from:e.attrs.to,id:e.attrs.id})}function Ae(t,e,r){var n=Te(t);return n.attrs.type="error",r&&n.append(r),n.append(e),n}function Me(t,e){return bt("error",{type:t},bt(e,Ce))}function Ne(i){return function(t,e){try{if(!function(t){var e=t.name,r=t.type;return"iq"===e&&("error"!==r&&"result"!==r)}(t))return e();var r,n=t.stanza.getChildElements(),o=n[0];return function(t,e,r){var n=t.type;return("get"===n||"set"===n)&&(1===e.length&&!!r)}(t,n,o)?(t.element=o,function(t,e){return t&&t.then?t.then(e):e(t)}(function(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}(function(){return function(t,e,r){if(r)return e?e(t()):t();try{var n=Promise.resolve(t());return e?n.then(e):n}catch(t){return Promise.reject(t)}}(e,function(t){r=t})},function(t){i.emit("error",t),r=Me("cancel","internal-server-error")}),function(){return(r=r||Me("cancel","service-unavailable"))instanceof bt.Element&&r.is("error")?Ae(t,r,o):function(t,e){var r=Te(t);return r.attrs.type="result",e&&r.append(e),r}(t,r instanceof bt.Element?r:void 0)})):Ae(t,Me("modify","bad-request"),o)}catch(t){return Promise.reject(t)}}}function qe(r,n,o,i){return function(t,e){return t.type!==r|!t.element||!t.element.is(o,n)?e():i(t,e)}}var Xe=function(t){var n=t.middleware,e=t.entity;return n.use(Ne(e)),{get:function(t,e,r){n.use(qe("get",t,e,r))},set:function(t,e,r){n.use(qe("set",t,e,r))}}},Fe={};function Re(t){return t.startsWith("https")||t.startsWith("wss")}Fe.compare=function(t,e){var r,n;return 0!==(r=Re(t.uri)&&!Re(e.uri)?-1:!Re(t.uri)&&Re(e.uri)?1:0)?r:0!==(n=t.method===e.method?0:"websocket"===t.method?-1:"websocket"===e.method?1:"xbosh"===t.method?-1:"xbosh"===e.method?1:"httppoll"===t.method?-1:"httppoll"===e.method?1:0)?n:0};var ze={};(function(t){"use strict";var e=t.fetch||re,r=Fe.compare;ze.resolve=function(t){return e("https://"+t+"/.well-known/host-meta").then(function(t){return t.text()}).then(function(t){return function(t){var e=new wt,r=null,n=null;if(e.on("start",function(t){r=t}),e.on("element",function(t){r.append(t)}),e.on("error",function(t){n=t}),e.write(t),e.end(),n)throw n;return r}(t).getChildren("Link").filter(function(t){return["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(t.attrs.rel)}).map(function(t){var e=t.attrs;return{rel:e.rel,href:e.href,method:e.rel.split(":").pop(),uri:e.href}}).sort(r)}).catch(function(){return[]})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var De;function Be(){}De=function(){return Promise.all([re.resolve?re.resolve.apply(re,arguments):Promise.resolve([]),ze.resolve.apply(ze,arguments)]).then(function(t){var e=t[0],r=t[1];return e.concat(r)})},re.resolve&&(De.dns=re),De.http=ze;var Ie=Ke(function(e,t){var r=!1;if(0===t.length)throw new Error("Couldn't connect");var n=t.shift(),o=e._findTransport(n);if(!o)return Ie(e,t);var i=o.prototype.socketParameters(n),s=new o.prototype.Socket;return function(t,e){return t&&t.then?t.then(e):e(t)}(He(function(){return Ue(Ye(s,i))},function(){return r=!0,Ie(e,t)}),function(t){if(r)return t;e._attachSocket(s),s.emit("connect"),e.Transport=o,e.Socket=o.prototype.Socket,e.Parser=o.prototype.Parser})});function Ue(t,e){if(!e)return t&&t.then?t.then(Be):Promise.resolve()}var We=Ke(function(t){return Je(De(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]}),function(t){return[].concat(new Set(t.map(function(t){return t.uri})))})});function He(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}function Je(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var Ye=At.socketConnect;function Ke(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var $e=function(t){var r=t.entity,e=r.connect;r.connect=function(t){try{return!t||t.match(/:\/\//)?e.call(this,t):Je(We(t),function(t){var e=function(e,t){return t.filter(function(t){return e._findTransport(t)})}(r,t);if(0===e.length)throw new Error("No compatible transport found.");return He(function(){return Ue(Ie(r,e))},function(t){throw r._reset(),r._status("disconnect"),t})})}catch(t){return Promise.reject(t)}}};var Ge=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t},Qe={};(function(e,r){"use strict";var n=re.Base64;Qe.encode=function(t){return e.btoa?e.btoa(t):e.Buffer?r.from(t,"utf8").toString("base64"):n.btoa(t)},Qe.decode=function(t){return e.atob?e.atob(t):e.Buffer?r.from(t,"base64").toString("utf8"):n.btoa(t)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},re.Buffer);var Ve,Ze=s(a),tr=function(o){function t(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(t=o.call.apply(o,[this].concat(r))||this).name="SASLError",t}return(0,Ze.default)(t,o),t}(Lt),er={exports:{}};function rr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function nr(){}Ve=function(t,e,r){(e.exports=r).Factory=r},"object"==typeof er.exports&&Ve(er.exports,er,n({})),er=er.exports;var or=ur(function(t,i,e,r){var s=t.create([e]);if(!s)throw new Error("No compatible mechanism");var n=i.options.domain,a=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?rr(r,!0).forEach(function(t){Ge(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):rr(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({username:null,password:null,server:n,host:n,realm:n,serviceType:"xmpp",serviceName:n},r);return new Promise(function(n,o){i.on("nonza",function t(e){if(e.attrs.xmlns===cr)if("challenge"!==e.name)"failure"===e.name?o(tr.fromElement(e)):"success"===e.name&&n(),i.removeListener("nonza",t);else{s.challenge(ar(e.text()));var r=s.response(a);i.send(bt("response",{xmlns:cr,mechanism:s.name},"string"==typeof r?sr(r):""))}}),s.clientFirst&&i.send(bt("auth",{xmlns:cr,mechanism:s.name},sr(s.response(a))))})});function ir(t,e){if(!e)return t&&t.then?t.then(nr):Promise.resolve()}var sr=Qe.encode,ar=Qe.decode;function ur(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var cr="urn:ietf:params:xml:ns:xmpp-sasl";var fr=function(t,i){var e=t.streamFeatures,s=new er;return e.use("mechanisms",cr,ur(function(t){var e=t.stanza,r=t.entity,n=function(t){return t.getChild("mechanisms",cr).children.map(function(t){return t.text()})}(e),o=s._mechs.map(function(t){return t.name}).filter(function(t){return n.includes(t)})[0];return function(t,e){var r=t();return r&&r.then?r.then(e):e(r)}(function(){return"function"==typeof i?ir(i(function(t){return or(s,r,o,t,e)},o)):(i.username||i.password||(o="ANONYMOUS"),ir(or(s,r,o,i,e)))},function(){return ir(r.restart())})})),{use:function(){return s.use.apply(s,arguments)}}};function lr(){}var hr=dr(function(r,t,e){return function(t,e,r){if(r)return e?e(t):t;t&&t.then||(t=Promise.resolve(t));return e?t.then(e):t}(t.request(bt("iq",{type:"set"},function(t){return bt("bind",{xmlns:mr},t&&bt("resource",{},t))}(e))),function(t){var e=t.getChild("bind",mr).getChildText("jid");return r._jid(e),e})});function pr(t,e){if(!e)return t&&t.then?t.then(lr):Promise.resolve()}var mr="urn:ietf:params:xml:ns:xmpp-bind";function dr(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}var vr=function(t,e){var r=t.streamFeatures,n=t.iqCaller;r.use("bind",mr,function(t,n){var o=t.iqCaller;return dr(function(t,e){var r=t.entity;return function(t,e){var r=t();return r&&r.then?r.then(e):e(r)}(function(){return pr("function"==typeof n?n(function(t){return hr(r,o,t)}):hr(r,o,n))},function(){e()})})}({iqCaller:n},e))};var yr,gr="urn:ietf:params:xml:ns:xmpp-session",wr=function(t){var n=t.iqCaller;t.streamFeatures.use("session",gr,function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(r.apply(this,t))}catch(t){return Promise.reject(t)}}}(function(t,e,r){return r.getChild("optional")?e():function(t,e,r){return r?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}(n.request(bt("iq",{type:"set"},bt("session",gr))),function(){return e()})}))},br={exports:{}};yr=function(t,e,r){(e.exports=r).Mechanism=r},"object"==typeof br.exports&&yr(br.exports,br,r({})),br=br.exports;var xr,_r=function(t){t.use(br)},Pr={exports:{}};xr=function(t,e,r){(e.exports=r).Mechanism=r},"object"==typeof Pr.exports&&xr(Pr.exports,Pr,e({})),Pr=Pr.exports;var Er=function(t){t.use(Pr)},jr={},Lr=s(o),Or=$t.xml,Sr=$t.jid,kr=$t.Client;return jr.xml=Or,jr.jid=Sr,jr.client=function(t){void 0===t&&(t={});var e=t,r=e.resource,n=e.credentials,o=e.username,i=e.password,s=(0,Lr.default)(e,["resource","credentials","username","password"]),a=s.domain,u=s.service;!a&&u&&(s.domain=Gt(u));var c=new kr(s),f=ee({entity:c}),l=pe({entity:c}),h=xe({entity:c}),p=Pe({middleware:h}),m=ke({middleware:h,entity:c}),d=Xe({middleware:h,entity:c}),v=$e({entity:c}),y=fr({streamFeatures:p},n||{username:o,password:i}),g=vr({iqCaller:m,streamFeatures:p},r),w=wr({iqCaller:m,streamFeatures:p}),b=Object.entries({plain:Er,anonymous:_r}).map(function(t){var e,r=t[0],n=t[1];return(e={})[r]=n(y),e});return Object.assign(c,{entity:c,reconnect:f,websocket:l,middleware:h,streamFeatures:p,iqCaller:m,iqCallee:d,resolve:v,sasl:y,resourceBinding:g,sessionEstablishment:w,mechanisms:b})},jr});
//# sourceMappingURL=xmpp.min.js.map